<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="css/bootstrap.min.css"/>
</head>
<body>

<div class="container-fluid">

    <table id="datatable" class="table table-condensed table-striped">
        <thead>
        <tr>
            <th>Fecha</th>
            <th>Nacionalidad</th>
            <th>Provincia</th>
            <th>Municipio</th>
            <th>Sexo</th>
            <th>Edad</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script type="text/javascript" src="js/jquery.min.js"></script>
<script type="text/javascript" src="js/underscore-min.js"></script>
<script type="text/javascript">
    $(function () {
        $.get('data/covid19-cuba.json', function (data) {
            let cuba_ages = {
                acum: 0,
                q: 0,
                hacum: 0,
                hq: 0,
                macum: 0,
                mq: 0
            };

            let ages = {};
            let $tbody = $('#datatable > tbody');
            _.each(data.casos.dias, function (dia) {
                let fecha = dia.fecha;
                _.each(dia.diagnosticados, function (diag) {
                    let tr = "<tr>" +
                        "<td>{fecha}</td>".replace('{fecha}', fecha) +
                        "<td>{nacionalidad}</td>".replace('{nacionalidad}', diag.pais) +
                        "<td>{provincia}</td>".replace('{provincia}', diag['provincia_detección']) +
                        "<td>{municipio}</td>".replace('{municipio}', diag['municipio_detección']) +
                        "<td>{sexo}</td>".replace('{sexo}', diag.sexo) +
                        "<td>{edad}</td>".replace('{edad}', diag.edad) +
                        "</tr>"

                    cuba_ages.acum += diag.edad;
                    cuba_ages.q++;

                    if (diag.sexo == 'hombre') {
                        cuba_ages.hacum += diag.edad;
                        cuba_ages.hq++;
                    } else {
                        cuba_ages.macum += diag.edad;
                        cuba_ages.mq++;
                    }

                    if (ages[diag['provincia_detección']] == undefined) {
                        ages[diag['provincia_detección']] = {
                            acum: 0,
                            q: 0,
                            hacum: 0,
                            hq: 0,
                            macum: 0,
                            mq: 0
                        };
                    }

                    ages[diag['provincia_detección']].acum+=diag.edad;
                    ages[diag['provincia_detección']].q++;

                    if (diag.sexo == 'hombre') {
                        ages[diag['provincia_detección']].hacum += diag.edad;
                        ages[diag['provincia_detección']].hq++;
                    } else {
                        ages[diag['provincia_detección']].macum += diag.edad;
                        ages[diag['provincia_detección']].mq++;
                    }

                    $tbody.append(tr);
                });
            });
            console.log({
                general: cuba_ages.acum / cuba_ages.q,
                hombres: cuba_ages.hacum / cuba_ages.hq,
                mujeres: cuba_ages.macum / cuba_ages.mq
            });
            // console.log(ages);
            console.log(_.map(ages, (item, index) => {
                return {
                    aplace: index,
                    gavg: item.acum / item.q,
                    gq: item.q,
                    havg: item.hacum/item.hq,
                    hq: item.hq,
                    mavg: item.macum/item.mq,
                    mg: item.mq,
                };
            }));
        });
    });
</script>
</body>
</html>
