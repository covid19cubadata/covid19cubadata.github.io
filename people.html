<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="css/bootstrap.min.css"/>
    <link rel="stylesheet" href="js/jui/jquery-ui.min.css"/>
    <link rel="stylesheet" href="js/datatables/datatables.min.css"/>
    <link rel="stylesheet" href="css/custom.css"/>
</head>
<body>

<nav class="navbar navbar-light bg-light">
    <a class="navbar-brand" href="#">
        <img id="logo" src="images/logo.jpg" alt="COVID-19 Cubadata">
    </a>
</nav>

<p id="apks-info" class="alert alert-info text-center">Descargue nuestra app desde <a
        href="https://www.apklis.cu/application/club.postdata.covid19cuba">Apklis <img class="app-logo"
                                                                                       src="images/apk-apklis.png"></a>
    o desde <a href="https://github.com/covid19cuba/covid19cuba-app/releases/download/v0.5.0/app.apk">Github
        <img class="app-logo" src="images/apk-github.png"></a>.
    También puede consultar a <a href="https://telegram.me/covid19cubadata_bot">@covid19cubadata_bot <img
            class="app-logo" src="images/bot-telegram.png"></a> en Telegram.
</p>
<div class="container-fluid">

    <form id="filter-form" class="card my-4">
        <div class="card-header">Filtrar casos</div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-2">
                    <div class="form-group">
                        <label for="date-start">Desde</label>
                        <input id="date-start" type="text" name="date_start" class="form-control form-control-sm"
                               value=""/>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group">
                        <label for="date-end">Hasta</label>
                        <input id="date-end" type="text" name="date_end" class="form-control form-control-sm" value=""/>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group">
                        <label for="nationality">Nacionalidad</label>
                        <select name="nationality" id="nationality" class="form-control form-control-sm">
                            <option value="">-- Cualquiera --</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group">
                        <label for="province">Provincia</label>
                        <select name="province" id="province" class="form-control form-control-sm">
                            <option>-- Cualquiera --</option>
                            <option value="pri">Pinar del Río</option>
                            <option value="pri">Artemisa</option>
                            <option value="pri">La Habana</option>
                            <option value="pri">Mayabeque</option>
                            <option value="pri">Matanzas</option>
                            <option value="pri">Villa Clara</option>
                            <option value="pri">Cienfuegos</option>
                            <option value="pri">Sancti Spíritus</option>
                            <option value="pri">Ciego de Ávila</option>
                            <option value="pri">Camagüey</option>
                            <option value="pri">Las Tunas</option>
                            <option value="pri">Holguín</option>
                            <option value="pri">Granma</option>
                            <option value="pri">Santiago de Cuba</option>
                            <option value="pri">Guantánamo</option>
                            <option value="pri">Isla de la Juventud</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group">
                        <label for="municipe">Municipio</label>
                        <select name="municipe" id="municipe" class="form-control form-control-sm"></select>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group">
                        <label for="sexo">Sexo</label>
                        <select name="sexo" id="sexo" class="form-control form-control-sm">
                            <option value="">Ambos</option>
                            <option value="mujer">Mujer</option>
                            <option value="hombre">Hombre</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="row mt-2">
                        <div class="col-md-2">
                            <div class="form-group">
                                <label for="age-start">Desde</label>
                                <input type="text" id="age-start" class="form-control form-control-sm" readonly
                                       name="age_start"
                                       value="1"/>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <label class="mb-3">Rango de Edad</label>
                            <div id="slider-age"></div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label for="age-end">Hasta</label>
                                <input type="text" id="age-end" class="form-control form-control-sm" readonly
                                       name="age_end"
                                       value="120"/>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-footer">
            <input type="submit" value="Buscar" class="btn btn-primary"/>
        </div>
    </form>

    <table id="datatable" class="table table-condensed table-striped">
    </table>
</div>
<div class="footer  row pb-4">
    <div id="info" class="col-12">
        <div class="row m-0">
            <div class="col-lg-4 col-md-4" id="data">Descarga los datos
                utilizados en formato <a href="data/covid19-cuba.json">JSON</a> o en formato <a
                        href="data/covid19-casos.csv">CSV</a>,
                que son actualizados a partir de la información oficial del MINSAP que es reportada
                al día siguiente.
            </div>
            <div class="col-lg-4 col-md-4" id="date">
            </div>
            <div class="col-lg-4 col-md-4" id="project">
                Este es un proyecto abierto y su código está en <a
                    href="https://github.com/covid19cubadata/covid19cubadata.github.io">Github</a>
            </div>
        </div>
    </div>

    <div class="col-12 text-center">


        <div class="text-block mt-4">
            Copyright 2020
            <div id="team-logos">
                <a href="#"><img class="team-logo" src="images/logo-matcom.png"></a>
                <a href="https://www.postdata.club/"><img class="team-logo" src="images/logo-pd.png"></a>
                <a href="#"><img class="team-logo" src="images/logo-jt.jpeg"></a>
            </div>
            <br>
            El sitio original <a href="http://covid19cubadata.github.io">Covid19CubaData</a> es replicado en:
        </div>
        <div><a href="http://www.cusobu.nat.cu/covid/">www.cusobu.nat.cu/covid/</a> cortesía de
            <a href="http://www.cusobu.nat.cu/"><img id="cusobu" class="" src="images/logo-cusobu.png"></a>
        </div>
        <div><a href="http://covid19.frcuba.cu">covid19.frcuba.cu</a> y <a href="http://coronavirus.frcuba.cu">coronavirus.frcuba.cu</a>
            cortesía de
            <a href="http://www.frcuba.cu/"><img id="fr" class="" src="images/logo-fr.png"></a>
        </div>
        <div><a href="http://covidcuba.swlx.info">covidcuba.swlx.info</a> cortesía de
            <a href="http://www.swlx.info/"><img id="swlx" class="" src="images/logo-swlx.png"></a>
        </div>
    </div>
</div>

<script type="text/javascript" src="js/jquery.min.js"></script>
<script type="text/javascript" src="js/jui/jquery-ui.min.js"></script>
<script type="text/javascript" src="js/datatables/datatables.min.js"></script>
<script type="text/javascript" src="js/underscore-min.js"></script>
<script type="text/javascript">
    let dateFormat = "yy/mm/dd";
    let domains = {
        'cu': 'Cuba',
        'it': 'Italia',
        'be': 'Bélgica',
        'us': 'USA',
        'fr': 'Francia',
        'ca': 'Canadá',
        'es': 'España',
        'cn': 'China',
        'ru': 'Rusia',
        'uy': 'Uruguay',
        'do': 'R.Dominicana',
        'hr': 'Croacia',
        'co': 'Colombia',
        'pe': 'Perú',
        'tz': 'Tanzania',
        'pa': 'Panamá',
        'bo': 'Bolivia'
    };

    $(function () {

        $.get('data/provincias.geojson', function (provincias) {
            $.get('data/municipios.geojson', function (municipios) {
                $.get('data/covid19-cuba.json', function (data) {

                    $datatable = $('#datatable').DataTable({
                        data: [],
                        columns: [
                            {title: "Fecha"},
                            {title: "Nacionalidad"},
                            {title: "Provincia"},
                            {title: "Municipio"},
                            {title: "Sexo"},
                            {title: "Edad"}
                        ]
                    });

                    let $dateStart = $("#date-start");
                    let $dateEnd = $("#date-end");

                    $dateStart.val("2020/03/11");
                    let today = new Date();
                    $dateEnd.val(today.getFullYear() + '/' + today.getMonth() + '/' + today.getDate());

                    let startDatePicker = $dateStart.datepicker({
                        defaultDate: "2020/03/11",
                        dateFormat: "yy/mm/dd",
                        minDate: "2020/03/11",
                    }).on("change", function () {
                        endDatePicker.datepicker("option", "minDate", getDate(this));
                    });

                    let endDatePicker = $dateEnd.datepicker({
                        defaultDate: 0,
                        dateFormat: "yy/mm/dd",
                        maxDate: new Date(),
                    }).on("change", function () {
                        startDatePicker.datepicker("option", "maxDate", getDate(this));
                    });

                    let $nationality = $('#nationality');
                    _.each(domains, function (item, index) {
                        $nationality.append($('<option></option>').attr('value', index).text(item));
                    });

                    let $ageStart = $("#age-start");
                    let $ageEnd = $("#age-end");

                    $("#slider-age").slider({
                        range: true,
                        min: 1,
                        max: 120,
                        values: [1, 120],
                        slide: function (event, ui) {
                            $ageStart.val(ui.values[0]);
                            $ageEnd.val(ui.values[1]);
                        }
                    });

                    $(document).on('submit', '#filter-form', function (e) {
                        e.preventDefault();
                        let filter = {};
                        _.each($(this).serializeArray(), function (item) {
                            filter[item.name] = item.value;
                        });
                        let dataSet = [];
                        _.each(data.casos.dias, function (dia) {
                            let fecha = dia.fecha;
                            if (
                                true
                                && (filter.date_start == '' || fecha >= filter.date_start)
                                && (filter.date_end == '' || fecha <= filter.date_end)
                            ) {
                                _.each(dia.diagnosticados, function (diag) {
                                    if (
                                        true
                                        && (filter.nationality == "" || diag.pais == filter.nationality)
                                        && (filter.province == "" || diag.DPA_province_code == filter.province)
                                        && (filter.municipe == "" || diag.DPA_municipality_code == filter.municipe)
                                        && (filter.age_start == "" || diag.edad >= filter.age_start)
                                        && (filter.age_end == "" || diag.edad <= filter.age_end)
                                        && (filter.sexo == "" || diag.sexo == filter.sexo)
                                    ) {
                                        dataSet.push([fecha, domains[diag.pais], diag['provincia_detección'], diag['municipio_detección'], diag.sexo, diag.edad])
                                    }
                                });
                            }
                        });

                        $datatable.clear();
                        $datatable.rows.add(dataSet);
                        $datatable.draw();


                    });
                    $('#filter-form').submit();

                });
            })
        });

    });

    function getDate(element) {
        var date;
        try {
            date = $.datepicker.parseDate(dateFormat, element.value);
        } catch (error) {
            date = null;
        }

        return date;
    }
</script>
</body>
</html>
